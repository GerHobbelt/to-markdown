define(function(e,n){var t=e("he"),r=function(e){function n(e,n){var t="void"===n.type?"<"+n.tag+"\\b([^>]*)\\/?>":"<"+n.tag+"\\b([^>]*)>([\\s\\S]*?)<\\/"+n.tag+">",r=new RegExp(t,"gi"),a="";return a="string"==typeof n.replacement?e.replace(r,n.replacement):e.replace(r,function(e,t,r,a){return n.replacement.call(this,e,t,r,a)})}function r(e){return new RegExp(e+"\\s*=\\s*[\"']?([^\"']*)[\"']?","i")}function a(e){return e=e.replace(/<(ul|ol)\b[^>]*>([\s\S]*?)<\/\1>/gi,function(e,n,t){var r=t.split("</li>");for(r.splice(r.length-1,1),o=0,u=r.length;u>o;o++)if(r[o]){var a="ol"===n?o+1+".  ":"*   ";r[o]=r[o].replace(/\s*<li[^>]*>([\s\S]*)/i,function(e,n){return n=n.replace(/^\s+/,""),n=n.replace(/\n\n/g,"\n\n    "),n=n.replace(/\n([ ]*)+(\*|\d+\.) /g,"\n$1    $2 "),a+n})}return r.join("\n")}),"\n\n"+e.replace(/[ \t]+\n|\s+$/g,"")}function c(e){return e=e.replace(/<blockquote\b[^>]*>([\s\S]*?)<\/blockquote>/gi,function(e,n){return n=n.replace(/^\s+|\s+$/g,""),n=p(n),n=n.replace(/^/gm,"> "),n=n.replace(/^(>([ \t]{2,}>)+)/gm,"> >")})}function p(e){return e=e.replace(/^[\t\r\n]+|[\t\r\n]+$/g,""),e=e.replace(/\n\s+\n/g,"\n\n"),e=e.replace(/\n{3,}/g,"\n\n")}for(var l=[{patterns:"p",replacement:function(e,n,t){return t?"\n\n"+t+"\n":""}},{patterns:"br",type:"void",replacement:"\n"},{patterns:"h([1-6])",replacement:function(e,n,t,r){for(var a="",c=0;n>c;c++)a+="#";return"\n\n"+a+" "+r+"\n"}},{patterns:"hr",type:"void",replacement:"\n\n* * *\n"},{patterns:"a",replacement:function(e,n,t){var a=n.match(r("href")),c=n.match(r("title"));return a?"["+t+"]("+a[1]+(c&&c[1]?' "'+c[1]+'"':"")+")":e}},{patterns:["b","strong"],replacement:function(e,n,t){return t?"**"+t+"**":""}},{patterns:["i","em"],replacement:function(e,n,t){return t?"_"+t+"_":""}},{patterns:"code",replacement:function(e,n,r){return r?"`"+t.decode(r)+"`":""}},{patterns:"img",type:"void",replacement:function(e,n){var t=n.match(r("src")),a=n.match(r("alt")),c=n.match(r("title"));return"!["+(a&&a[1]?a[1]:"")+"]("+t[1]+(c&&c[1]?' "'+c[1]+'"':"")+")"}}],o=0,u=l.length;u>o;o++)if("string"==typeof l[o].patterns)e=n(e,{tag:l[o].patterns,replacement:l[o].replacement,type:l[o].type});else for(var i=0,s=l[o].patterns.length;s>i;i++)e=n(e,{tag:l[o].patterns[i],replacement:l[o].replacement,type:l[o].type});e=e.replace(/<pre\b[^>]*>`([\s\S]*)`<\/pre>/gi,function(e,n){var r=t.decode(n);return r=r.replace(/^\t+/g,"  "),r=r.replace(/\n/g,"\n    "),"\n\n    "+r+"\n"}),e=e.replace(/^(\s{0,3}\d+)\. /g,"$1\\. ");for(var f=/<(ul|ol)\b[^>]*>(?:(?!<ul|<ol)[\s\S])*?<\/\1>/gi;e.match(f);)e=e.replace(f,function(e){return a(e)});for(var g=/<blockquote\b[^>]*>((?:(?!<blockquote)[\s\S])*?)<\/blockquote>/gi;e.match(g);)e=e.replace(g,function(e){return c(e)});return p(e)};return"object"==typeof n&&(n.toMarkdown=r),r});